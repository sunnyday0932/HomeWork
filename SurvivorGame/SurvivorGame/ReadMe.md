# 選擇題目理由
  第一眼想到 Dead by Daylight 這個遊戲內容，決定先從此題下手。

# 文件內容
  - docs
    - DiscussionContext : 內有完整與 AI 對話設計此 POC 內容。
    - *Result 等檔案 : 模擬測試結果內含 aggreate(總結結果)、episode.json(每一 run 關鍵事件)、summary (每次模擬的最終勝利方)
    - memory.json : 供未來其他對話視窗此 AI 可以快速回憶起之前對話的內容摘要。

# 程式架構
  - .net 8 
  - 本專案直接使用 xunit 測試框架進行開發，可直接執行 dotnet test ，例行執行僅測試重要邏輯，需要執行較久的測試程式目前先行使用 skip 跳過，有需要執行時手動開啟

# 總結摘要
---

# 整體研究紀錄概覽

## 1. 初始規則設計

* **回合制**：100 回合上限，鬼先行動，之後所有角色同類型同時行動。
* **地圖**：二維陣列，有限邊界。初始 POC 規模 50×50，未來可調整。
* **角色**：

  * 生存者：1–3 位
  * 鬼：2–5 位
* **移動**：八方向（上下左右＋對角），一次一步。
* **勝利條件**：

  * 生存者：到達出口並逃脫得分；若 100 回合仍有人未逃脫 → 視為失敗。
  * 鬼：捕獲生存者得分；若場上無生存者或時間到仍有生存者 → 鬼勝。
* **占位規則**：所有角色不可同格，禁止交換位置。
* **初始佈局**：角色需與出口保持一定距離。

---

## 2. 生存者策略

* **視野**：5×5（半徑=2），只能看到附近的鬼，但出口為全知。
* **策略流程**：

  1. **距離計算**：BFS → 得到 `D_exit`（到出口距離場）、`D_killer`（到可見鬼距離場）。
  2. **評分 (Scoring)**：對候選移動格進行打分：

     * 越靠近出口分數越高。
     * 越遠離鬼分數越高。
     * 特殊懲罰／加分：

       * `D_killer ≤ 2` → 強懲，避免自殺貼近鬼。
       * 一步 lookahead，避免下回合被鬼貼臉。
       * `UnknownAreaPenalty`：未知區域會被小扣分（鼓勵靠近有資訊的方向）。
       * `LastSeenShadowPenalty`：避免走進最近看過鬼的陰影區域。
  3. **決策**：挑選分數最高的候選步。

---

## 3. 鬼策略

* **視野**：7×7（半徑=3），比生存者大。出口為全知。
* **策略流程**：

  1. **目標選擇**：

     * 有可見生存者 → 追最近者。
     * 無可見生存者 →

       * 若有 last-seen → 追擊。
       * 超過 timeout → 轉巡邏最近出口。
       * 無資訊 → 隨機遊走。
  2. **評分 (Scoring)**：

     * `-dist_to_target`：越靠近目標分數越高。
     * `InterceptBonus`：靠近出口路徑有加分。
     * `SpacingPenalty`：避免鬼之間重疊或過於緊鄰。
     * `PatrolBonus`：靠近出口或 last-seen 區域時小加分。
  3. **決策**：挑選分數最高的候選步。

---

## 4. BFS 與 DFS 的比較與適用性

* **DFS**：不保證最短路徑，不適合此需求。
* **BFS**：能保證最短路徑，適合用來產生 `D_exit` 與 `D_killer` 的距離場。
* **限制**：環境動態（鬼、生存者同時移動），因此 BFS 結果只能做當前回合的決策，無法長期重複利用。

---

## 5. 測試設計與驗證 (xUnit)

### A. 初始化與不變式

* 驗證地圖初始化正確：大小、出口、生存者與鬼位置、Alive 狀態。
* 驗證 `InBounds` 邏輯。

### B. 回合流程

* 驗證每回合包括 **Killer Phase → Survivor Phase**。
* 驗證所有角色的移動符合八方向且不越界。

### C. BFS 與距離場

* 驗證 `BuildExitField` 正確生成距離場。
* 驗證 `BuildVisibleKillerField` 僅考慮可見鬼（5×5 視野），不可見鬼不影響。

### D. Survivor Policy（Scoring）

* **E16** 出口相鄰 → 必選出口。
* **E17** 危險格（`D_killer ≤ 2`）不會被選。
* **E18** 一步 lookahead → 不走鬼下一步可貼臉的格。
* **E19** UnknownAreaPenalty → 偏向包含鬼的已知視窗，避免未知。
* **E20** LastSeenShadow → 避開陰影半徑內的格。

### F. Killer Policy

* **F21** 視野內 → 鎖定最近生存者。
* **F22** 看不見時 → 使用 last-seen 追擊。
* **F23** 超過 timeout → 巡邏最近出口。
* **F24** SpacingPenalty → 在等距候選下選不緊鄰其他鬼者。

### G. MoveConflictResolver

* **G25** 同格競爭：高分者得。
* **G26** 同分 → Id 較小者得。
* **G27** 禁止兩人互換位置（no-swap）。
* **G28** 跟隨鏈：目前只阻擋雙人交換，三人以上循環未實作（測試分為 expectation skip 與 current 行為驗證）。

### H. 事件與分數

* **H29** 捕獲 → 鬼得分+1，被捕生存者移除。
* **H30** 逃脫 → 生存者得分+1，該生存者移除。
* **H31** 同回合事件順序：鬼Phase捕獲 → 生存者Phase先逃脫 → 再捕獲。

### I. 統計穩健性

* **I32** 穩定性：同參數多批次模擬，鬼勝率差異不可過大（≤20%）。
* **I33** 單調性：提高生存者視野 → 鬼勝率不可上升，生存者得分不可下降。

---

## 6. 批次模擬與結果輸出

* 新增 **事件紀錄 (`GameEvent`)**，支援輸出：

  * `episode_xxxx.ndjson`：逐回合事件（捕獲、逃脫）。
  * `summary.csv`：每場摘要（勝者、回合數、雙方分數）。
  * `aggregate.json`：整體統計（鬼勝率、生存者平均分、鬼平均分、平均回合）。
* 測試案例需求：

  1. 紀錄每次模擬的關鍵事件。
  2. 紀錄每場最終勝者。
  3. 彙整統計並指出哪一方勝率較高。

---

## 總結

目前已經完成：

1. **規則設計**（角色、地圖、移動、勝負條件、視野限制）。
2. **雙方策略**（生存者 BFS + scoring、鬼有限視野 + last-seen + spacing）。
3. **演算法核心**（BFS 距離場、scoring function、conflict resolver）。
4. **完整測試套件**（從初始化 → 移動流程 → 策略驗證 → 衝突解算 → 分數事件 → Monte Carlo 穩健性）。
5. **批次模擬輸出**，能夠產生逐回合事件、每場結果、最終統計。

---

