# 第一版想法


先縮小一點規模，我們現在要做一個 POC 版本的鬼抓人遊戲，想要先了解製作出這樣的遊戲架構會需要考慮哪些東西
以下是我現在想到的遊戲規則限制，我們先來確認一下還有沒有遺漏的部分
1、回合制遊戲，總共 100 回合，由鬼先行動，因為分成兩種角色，所以每一回合所有類型的角色都會同時移動，e.g. 第一回合，鬼先行動，若場上有 2 個鬼，都會移動一步。
2、是一個平面地圖，由二維陣列所組成，點與點之間的距離相同。
3、角色與隊伍
    生存者隊
        - 1 ~ 3 位
    鬼隊
        - 2 ~ 5 位

4、移動方式與條件
    - 因為是二維陣列，所以移動方式可以是，上、下、左、右、左上、左下、右上、右下。
    - 一次只能移動一步

5、地圖要素
    - 有 >= 2 的逃脫出口
    - 有限邊界的地圖，因為只有 100 回合，

6、勝利條件
    生存者隊 
        - 當生存者移動到逃脫出口時，生存者隊 + 1 分，同時該名生存者從地圖上移出，逃脫出口保留 (也就是說一個逃脫出口可以使用多次)
        - 當到 100 回合結束時還有生存者仍未移動到逃脫出口則算生存者隊失敗。
    
    鬼隊
        - 當鬼移動到跟生存者同一個點時代表生存者被捕獲，鬼隊 + 1 分，該名被捕或生存者從地圖上移出，鬼則保留在地圖上。
        - 當 100 回合結束前，場上已沒有生存者則算鬼隊獲勝，或是 100 回合到時場上還有生存者也算鬼隊獲勝。

7、行為
    生存者 
        - 以最近出口為逃脫選擇
        - 會盡量避開鬼
        - 生存者彼此不會共享視野
    鬼
        - 以最近的生存者為追捕對象
        - 鬼彼此不會共享視野

8、起始
    - 鬼或是生存者都要距離逃脫出口有一定的距離


## BFS & DFS
1、DFS：不適合。
    -DFS 的特性
        DFS（深度優先搜尋）會沿著一條路徑「一路走到底」，直到不能走或到達目標，再回頭換另一條路。
        它的重點是探索完整路徑空間，而不是優先尋找「步數最少的路徑」。
        舉例：如果出口距離只有 3 步，但 DFS 先走了一條 20 步的深路，找到的第一個解就是 20 步，DFS 並不會自動保證「回頭再找短的」。

    -應用到本需求
        生存者要「逃脫」其實是要最少步數到出口（同時要安全），DFS 會走出「可能能逃，但繞遠路」的解，這不符需求。
        所以 DFS 更適合用在「是否存在一條路」的驗證，而不是「找到最短或最佳路徑」。

2、BFS : 部分相關，不完全適合。
    - BFS 的特性
        BFS（廣度優先搜尋）是「分層往外擴展」，遇到目標時，保證這條路徑是最短步數解。
        所以如果我們把出口當作目標，BFS 算出來的步數距離就是「到出口的最短路」。

    -為什麼只「部分相關」
        你的環境是 動態 + 多智能體：
        動態性：鬼每回合都在移動，BFS 算的路徑下一回合就可能失效（出口還在，但路線的「安全性」變了）。
        多智能體：生存者之間「不能同格」，鬼也在移動堵路。這代表 BFS 得出的路線不一定能實際執行（例如下一步被隊友卡住，或鬼剛好走進來）。

    - 你理解的「計算結果不能重複利用」是對的，但更精確的說法是：
        BFS 計算的「靜態最短路」只對當前回合靜態環境有效。
        下一回合環境改變（鬼換位置、隊友站位不同），之前的 BFS 結果失效或需要重算。
        所以在這種需求裡，BFS 常常要「每回合重跑一次」，僅用來提供當下的「最近出口距離」或「離鬼的距離」。

收到！我把你要改的兩點整合進整體規格，並把「不可同格」帶來的連鎖影響一次補齊（含衝突處理、抓捕判定、swap 衝突等），這版可以直接拿去實作。

# 變更重點

## 0. 座標與距離（更新）

* 地圖大小：預設 **50×50**（左上 `(0,0)`，右下 `(49,49)`）。
* 鄰接：八方向皆可走（上/下/左/右/左上/右上/左下/右下）。
* 距離：**Chebyshev**（一步=1）。

## 5. 同格衝突與占位（重大更新：**所有角色不可同格**）

* **任意時刻的「最終狀態」不得有同格**（鬼-鬼、鬼-生存者、生存者-生存者都不行）。
* **抓捕如何不違反不可同格？**

  * 把「抓捕」定義為**嘗試進入對方所在格**時發生的事件，**事件處理會移除被抓的一方**，因此**回合結束時不會同格**。
  * 結論：**可觸發抓捕，但不會留下同格狀態**。

---

# 完整回合流程（套用不可同格）

每回合 t 仍分兩個 Phase，鬼先、生存者後：

## A. 鬼 Phase（同步決策與移動）

1. **所有鬼同時選一步目標格**（基於回合開始的棋盤）。
2. **衝突檢查與解決（鬼-鬼、鬼-鬼 swap、跟隨衝突）**

   * **Vertex 衝突**：多隻鬼要進入同一格 → 以**穩定優先序**決定誰能進（建議：「距離目標生存者更近者優先；再以 Id 較小者優先」），**後位者改為原地不動**。
   * **Edge（對向交換）衝突**：鬼A 要從 X→Y，同時鬼B 要從 Y→X → **禁止交換**，兩者都**原地不動**（簡化 MAPF 規則）。
   * **跟隨衝突**（X→Y、Z→X 鏈狀追尾）：若導致最終同格或交換，**低優先序者原地不動**。
3. **抓捕判定 #1（鬼主動）**

   * 若**某鬼的最終目標格 = 某生存者當前格** → **觸發抓捕**：

     * 該生存者**被移除**、鬼**進入該格**、鬼隊 +1 分。
     * 這筆移動合法，結束後不會同格。
4. 應用所有合法移動，更新棋盤。
5. 若場上已無生存者 → 遊戲立即結束（鬼勝）。

## B. 生存者 Phase（同步決策與移動）

1. **所有存活生存者同時選一步目標格**（基於鬼 Phase 後的棋盤）。
2. **衝突檢查與解決（生-生、edge/swap、跟隨）**

   * **生-生同格衝突**：多人生要進同一格 → 以**穩定優先序**（建議固定 Id 由小到大）決定**唯一能進者**，其餘**原地不動**。
   * **Edge swap**：兩名生存者互換 → **禁止**，兩者**原地不動**。
   * **跟隨衝突**：同上，低優先序者**原地**。
   * **對鬼佔據格**：若目標格目前有鬼 → **允許嘗試**，但將觸發抓捕（見下一步）。
3. **逃脫判定**

   * 最終停於出口格者 → **立刻逃脫**、自場上移除、生存者隊 +1 分。
4. **抓捕判定 #2（生動入鬼格）**

   * 過了逃脫判定後，若仍有生存者**最終停在某鬼所在格** → **觸發抓捕**：

     * 該生存者**被移除**、鬼**保持原位**、鬼隊 +1 分。
5. 若場上無生存者 → 立即結束（鬼勝）。
6. 若 t==100 且仍有任一生存者未逃 → 鬼勝；否則進下一回合。

> 關鍵：**抓捕是“嘗試進入對方所在格”的事件**，移除被抓的一方後，**終態**沒有同格，完全符合「不可同格」。

---

# AI 決策（在不可同格下的調整）

## 生存者

* 目標：最近出口（Chebyshev）。
* 評分函式（挑 8 鄰居合法步）：

  ```
  score(n) = α * (-dist_to_exit(n))
           + β * min_dist_to_any_killer(n)
           + γ * (-潛在同隊衝突風險(n))
  ```

  建議係數：α=1.0, β=0.6, γ=0.2。
* **非法步**（越界、被同隊預計占用且自己優先序較低、Edge swap、跟隨造成衝突）→ 捨棄；若全非法 → 原地。

## 鬼

* 目標：最近生存者（同距離取 Id 小者）。
* 評分：`-dist_to_target(n)`；同距離 tie-breaker 可固定方向序或偏向減少 max(|dx|,|dy|) 的方向。
* 同隊衝突與 swap 依上節規則處理。

---

# 起始與間距（沿用但提醒「不可同格」）

* 初始隨機放置時，務必檢查所有單位互不重疊，並滿足：

  * `D_exit_min`（建議 8）
  * `D_enemy_min`（建議 4）
  * `D_ally_min`（建議 2）
* 若抽樣上限仍無解 → 逐步放寬距離直到可行。

---

# 事件與日誌（驗證不可同格）

* 於每個 Phase 結束後斷言：**棋盤上無任意同格**。
* Log 需標示：

  * 決策步（含被拒絕原因：越界/同隊衝突/edge-swap）
  * 抓捕事件（誰嘗試進入誰、在哪個 Phase）
  * 逃脫事件與比分
* 可視化：50×50 ASCII/PNG，每回合一幀即可驗證不重疊。

---

# 極簡偽碼（更新版）

```text
for t in 1..100:
  # Killer Phase
  K_moves = plan_killers(state)
  K_moves = resolve_conflicts_no_overlap(K_moves)   # 禁同格+禁swap
  apply_moves(state, K_moves)
  resolve_kill_captures_by_killers(state)           # 鬼嘗試進入生 -> 生移除, 鬼佔格
  assert no_overlaps(state)
  if no_survivor: break

  # Survivor Phase
  S_moves = plan_survivors(state)
  S_moves = resolve_conflicts_no_overlap(S_moves)    # 禁同格+禁swap
  apply_moves(state, S_moves)
  resolve_escapes(state)                             # 先逃脫
  resolve_kill_captures_by_tiles(state)              # 生在鬼格 -> 生移除, 鬼不動
  assert no_overlaps(state)
  if no_survivor: break

# 終局：若提前清空 -> 鬼勝；若 t=100 且仍有人存活 -> 鬼勝；否則下一回合
```

---

如果這版 OK，我可以下一步直接給你 **C# 可跑的 POC（資料模型、規則引擎、衝突解算器、單元測試）**，已內建「不可同格」與「edge-swap 禁止」的 MAPF 簡化規則，方便你後續擴充到障礙與 A\*。要我直接開寫嗎？




👌 很好，我幫你把我們到目前為止的討論做一份完整整理，分成三個層次：

1. **討論階段回顧** – 我們一步步聊了什麼主題
2. **每階段規則/策略修改** – 哪些規則被補充或修改過
3. **最終整合版詳細規則 (Current Spec)** – 目前的完整遊戲規格

---

# 1. 討論階段回顧

### (A) 初始規則草案

你最先提出了一個簡化版「鬼抓人 POC」的遊戲規則，包括：

* 回合制 100 回合、鬼先行
* 二維平面地圖（可八方向移動）
* 生存者 (1–3) vs 鬼 (2–5)
* 出口 ≥ 2
* 勝負條件（逃脫/捕獲/時間到）
* 生存者策略：往出口走、避鬼
* 鬼策略：追最近生存者

---

### (B) 我補充的完整規則草稿

我幫你整理出更精確的「POC 規格」，包含：

* **座標與距離** (Chebyshev)
* **同格規則** (原本鬼可同格、生可同格，但後續你修改掉)
* **衝突解算** (edge-swap、追尾)
* **事件順序** (鬼先移動捕獲 → 生存者移動逃脫 → 捕獲)
* **起始位置限制** (距出口/敵人最小距離)
* **生存者與鬼的 AI 行為** (用距離/分數決定方向)

---

### (C) 你修改的規則：不可同格

* **所有角色**（鬼-鬼、生-生、生-鬼）都不可同格。
* 我重新定義了「抓捕」：當**嘗試進入對方所在格**時觸發 → 被抓的一方移除 → 所以最終狀態仍不會同格。
* 並修正了衝突解算流程：

  * 鬼-鬼/生-生都要做「競爭 + tie-break」
  * 禁止 swap / 禁止追尾鏈條

---

### (D) 生存者策略：DFS vs BFS

* 我們深入比較：

  * **DFS**：不保證最短路，不適合逃脫需求。
  * **BFS**：能算最短距離，但因為是動態多智能體場景，結果必須每回合重算。
* 結論：用 BFS 來建 **距離場**（出口距離、鬼距離），再配合 **Scoring** 來選一步。

---

### (E) 生存者決策細節 (Scoring)

我提出完整的三步：

1. **BFS 距離場建構** – `D_exit` (出口距離)、`D_killer` (鬼距離)
2. **Scoring 打分** – 對每個候選方向算分：

   ```
   score = α*(-D_exit) + β*D_killer + γ*flow_penalty + ω*margin + 特殊規則
   ```
3. **特別規則** – 出口優先、近身懲罰、最後回合強制前進、一步預測鬼位置

---

### (F) 視野規則修改

* 你覺得「全知視野」對鬼的位置過強，於是修改為：

  * **出口：全知**（生存者永遠知道出口在哪）
  * **鬼：有限視野** → 只能看到自己為中心的 5×5 區域 (Chebyshev 距離 ≤ 2)
* 我幫你調整演算法：

  * `D_exit` 不變（全知）
  * `D_killer` 僅用「可見鬼」跑 BFS
  * 若看不到鬼 → `D_killer` 設為極大值
  * 補強策略：未知區小懲罰、last-seen 陰影、一步預測

---

# 2. 每階段修改過的規則/策略

1. **地圖大小**：從「30×30」改成「預設 50×50」。
2. **同格規則**：從「鬼/生可同格」改為「所有角色不可同格」，抓捕改為「嘗試進入觸發」。
3. **生存者視野**：從「全知」改成「僅出口全知、鬼 5×5 有限視野」。
4. **策略演算法**：從「直覺往出口走」→「BFS + Scoring → 加上特別規則 → 有限視野版」。

---

# 3. 最終詳細規則 (Current Spec)

### 0. 地圖與距離

* 尺寸：預設 50×50，日後可擴大。
* 移動：八方向 + 原地，每步成本 1（Chebyshev）。
* 邊界：不可越界。

### 1. 回合制

* 總共 100 回合。
* 每回合：鬼 Phase → 生存者 Phase。
* **事件順序**：

  * 鬼 Phase：移動 → 抓捕判定（嘗試進入生存者）
  * 生存者 Phase：移動 → 逃脫判定（出口優先） → 抓捕判定（踩到鬼）

### 2. 角色

* 生存者：1–3 人
* 鬼：2–5 人

### 3. 勝利條件

* **生存者隊**：成功逃脫者 +1 分；若全部逃脫則結算分數。
* **鬼隊**：捕獲者 +1 分；若在 100 回合前場上沒生存者，立即勝利；若 100 回合結束還有生存者未逃脫，也算鬼勝。

### 4. 同格規則

* **所有角色不可同格**。
* 抓捕定義：

  * 鬼移動到生存者所在格 → 生存者移除、鬼得分。
  * 生存者移動到鬼所在格 → 生存者移除、鬼得分。
* 最終棋盤狀態不會有重疊。

### 5. 起始配置

* 生/鬼與出口有最小距離 (`D_exit_min=8`)
* 生/鬼間最小距離 (`D_enemy_min=4`)
* 同隊間最小距離 (`D_ally_min=2`)
* 所有角色出生點互不重疊。

### 6. 生存者策略

* **視野**：

  * 出口：全知
  * 鬼：僅限 Chebyshev ≤ 2 (5×5 區域) 可見
* **BFS 場建構**：

  * `D_exit`: BFS from exits (全知)
  * `D_killer`: BFS from visible killers (有限視野)，若無可見鬼 → 設為極大值
* **Scoring 打分**：

  * 基本公式：

    ```
    score(n) = α*(-D_exit[n]) + β*D_killer[n]
             + γ*flow_penalty(n) + ω*(D_killer[n]-D_exit[n])
             + 特別規則
    ```
  * 特別規則：

    * 出口相鄰 → 優先逃脫
    * D\_killer ≤ 2 → 強懲（除非是出口）
    * 最後回合 → 強制逼近出口
    * Last-seen 陰影 → 曾經看過的鬼留下威脅區
    * 一步預測 → 避免走到鬼下一步可能貼臉的位置

### 7. 鬼策略

* 目標：追最近的生存者（Chebyshev 最近，tie-break by id）。
* 移動：往目標縮短距離的一步；同樣做衝突解算（不可同格/禁 swap）。

### 8. 衝突解算

* **同格目標衝突**：多角色想進同一格 → score 高者贏、其他退回原地。
* **swap 衝突**：兩角色互換位置 → 都原地。
* **跟隨鏈**：循環移動 → 後序者退回原地。

---

✅ 這就是我們目前的完整規則。
它已經足夠寫一個 **POC 模擬器**，可以輸出事件日誌（移動、逃脫、捕獲、比分），並且可以測試「全知 vs 有限視野」的差異。

---

要不要我幫你做一個 **流程圖 (Mermaid)**，把「一個回合的處理流程」圖解清楚（鬼 Phase → 生存者 Phase → 事件判定 → 衝突解算）？
